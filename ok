import streamlit as st
import numpy as np
import pandas as pd
import plotly.express as px
from scipy.stats import binom, poisson, norm

# Criação de abas para diferentes distribuições
tab1, tab2, tab3, tab4 = st.tabs([
    "Distribuição Binomial", 
    "Distribuição Poisson", 
    "Distribuição Normal", 
    "Simulação Interativa de ROI"
])

# --- QUESTÃO 1 ---
with tab1:
    st.header("Distribuição Binomial: Overbooking Aéreo")
    st.markdown("""
**Contexto Detalhado:**
A Aérea Confiável vendeu um número de passagens acima da capacidade do voo para maximizar a ocupação, apostando que nem todos os passageiros comparecerão. Este módulo interativo permite ajustar parâmetros-chave e visualizar, de forma dinâmica, o comportamento da probabilidade de overbooking e suas implicações financeiras.  
""")

    # Inputs interativos
    vendidos = st.slider("Passagens Vendidas", min_value=120, max_value=200, value=130)
    p = st.slider("Taxa de Comparecimento (%)", min_value=0.0, max_value=1.0, value=0.88, step=0.01)
    capacidade = st.number_input("Capacidade do Voo", min_value=1, value=120)

    # Distribuição Binomial
    xs = np.arange(0, vendidos + 1)
    pmf = binom.pmf(xs, vendidos, p)
    df_pmf = pd.DataFrame({"Comparecimentos": xs, "Probabilidade": pmf})

    fig_pmf = px.bar(
        df_pmf, x="Comparecimentos", y="Probabilidade",
        title="Distribuição Binomial de Comparecimento",
        labels={"Probabilidade": "P(X = k)"}
    )
    fig_pmf.add_vline(x=capacidade, line_dash="dash", line_color="red",
                     annotation_text="Capacidade", annotation_position="top right")
    st.plotly_chart(fig_pmf, use_container_width=True)

    # Cálculo de overbooking
    prob_overbooking = 1 - binom.cdf(capacidade, vendidos, p)
    st.metric("Probabilidade de Overbooking (> capacidade)", f"{prob_overbooking:.2%}")

    # Limite de risco 7%
    st.subheader("Limite de Risco de Overbooking (≤ 7%)")
    vendas_test = np.arange(capacidade, vendidos * 2 + 1)
    riscos = [1 - binom.cdf(capacidade, n, p) for n in vendas_test]
    df_risco = pd.DataFrame({"Passagens Vendidas": vendas_test, "Risco": riscos})
    fig_risco = px.line(
        df_risco, x="Passagens Vendidas", y="Risco",
        title="Risco de Overbooking vs. Passagens Vendidas",
        labels={"Risco": "Probabilidade"}
    )
    fig_risco.add_hline(y=0.07, line_dash="dash", line_color="red",
                        annotation_text="Limite 7%", annotation_position="bottom right")
    st.plotly_chart(fig_risco, use_container_width=True)
    max_seguro = df_risco[df_risco["Risco"] <= 0.07]["Passagens Vendidas"].max()
    if not np.isnan(max_seguro):
        st.success(f"Máximo seguro de passagens: **{int(max_seguro)}** mantendo risco ≤ 7%.")
    else:
        st.error("Nenhuma quantidade de passagens mantém o risco abaixo de 7%.")

    # Análise Financeira
    st.subheader("Viabilidade Financeira: +10 Assentos")
    custo_ind = st.number_input("Custo de Indenização por Passageiro (R$)", value=500)
    preco_medio = st.number_input("Preço Médio por Passagem (R$)", value=500)
    lucro_extra = 10 * preco_medio
    custo_esperado = prob_overbooking * custo_ind * (vendidos - capacidade)
    st.metric("Lucro Bruto com 10 Passagens Extras", f"R$ {lucro_extra:,.2f}".replace(",", "."))
    st.metric("Custo Esperado de Indenizações", f"R$ {custo_esperado:,.2f}".replace(",", "."))

    texto_critico = (
        "**Análise Crítica:**\n"
        "- Mesmo com aumento de receita, o custo esperado de indenizações pode reduzir significativamente a margem de lucro.\n"
        "- Dependendo do perfil dos clientes e custo reputacional, a estratégia deve ser balanceada com seguros ou políticas de flexibilização no embarque."
    )
    st.markdown(texto_critico)

# --- DISTRIBUIÇÃO POISSON ---
with tab2:
    st.header("Distribuição de Poisson - Chegada de Clientes")
    lambda_val = st.slider("Taxa média de chegada (λ por hora)", 1, 20, 5)
    horas = np.arange(0, 15)
    df_poisson = pd.DataFrame({"Número de Clientes": horas,
                               "Probabilidade": poisson.pmf(horas, mu=lambda_val)})
    fig_poisson = px.bar(
        df_poisson, x="Número de Clientes", y="Probabilidade",
        title="Distribuição de Poisson",
        labels={"Probabilidade": "P(X = k)"}
    )
    st.plotly_chart(fig_poisson, use_container_width=True)

# --- DISTRIBUIÇÃO NORMAL ---
with tab3:
    st.header("Distribuição Normal - Vendas de Produtos")
    media = st.slider("Média de Vendas", 50, 150, 100)
    desvio = st.slider("Desvio Padrão", 5, 30, 15)
    x = np.linspace(media - 4*desvio, media + 4*desvio, 200)
    df_normal = pd.DataFrame({"Vendas": x, "Densidade": norm.pdf(x, media, desvio)})
    fig_normal = px.area(
        df_normal, x="Vendas", y="Densidade",
        title="Distribuição Normal das Vendas"
    )
    st.plotly_chart(fig_normal, use_container_width=True)

# --- QUESTÃO 2 ---
with tab4:
    st.header("Simulação Interativa de ROI - Sistema de Informação")
    st.markdown("""
Neste módulo, você pode ajustar parâmetros financeiros e quantidade de simulações para entender como a incerteza afeta o retorno sobre o investimento do novo sistema.
""")
    receita_esp = st.number_input("Receita Adicional Esperada (R$)", value=80000)
    custo_op = st.number_input("Custo Operacional Anual (R$)", value=10000)
    investimento = st.number_input("Investimento Inicial (R$)", value=50000)
    n_sim = st.slider("Número de Simulações Monte Carlo", 100, 5000, 1000, step=100)

    roi_esp = (receita_esp - custo_op) / investimento * 100
    st.metric("ROI Esperado", f"{roi_esp:.2f}%")

    # Simulação Monte Carlo
    sim_receita = np.random.normal(loc=receita_esp, scale=0.2 * receita_esp, size=n_sim)
    sim_lucro = sim_receita - custo_op
    sim_roi = (sim_lucro / investimento) * 100

    df_sim = pd.DataFrame({"ROI (%)": sim_roi})
    fig_hist = px.histogram(
        df_sim, x="ROI (%)", nbins=40,
        title="Distribuição Simulada de ROI",
        labels={"ROI (%)": "% de ROI"}
    )
    st.plotly_chart(fig_hist, use_container_width=True)

    # Gráfico CDF para insights
    fig_cdf = px.ecdf(
        df_sim, x="ROI (%)", title="CDF do ROI Simulado"
    )
    st.plotly_chart(fig_cdf, use_container_width=True)

    prob_neg = np.mean(sim_roi < 0)
    st.metric("Probabilidade ROI Negativo", f"{prob_neg:.2%}")

    # Interpretação de cenários formatada separadamente
    texto_cenarios = (
        "**Interpretação de Cenários:**\n"
        f"- Cenário Otimista: ROI máximo de aproximadamente **{np.max(sim_roi):.2f}%**.\n"
        f"- Cenário Pessimista: ROI mínimo de aproximadamente **{np.min(sim_roi):.2f}%**.\n"
        f"- Probabilidade de retorno negativo de **{prob_neg:.2%}** sugere necessidade de estratégias de mitigação de risco."
    )
    st.markdown(texto_cenarios)

    if np.mean(sim_roi) > 0:
        st.success("Investimento demonstra ROI médio positivo e potencial viabilidade.")
    else:
        st.warning("Média de ROI negativa: revisão de custos e premissas recomendada.")
